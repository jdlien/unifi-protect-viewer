<!doctype html>
<html lang="en">
  <head>
    <title>UniFi Protect Viewer - Configuration</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/styles.css" />
  </head>

  <body>
    <main>
      <div class="logo">
        <img src="../img/512.png" alt="logo" />
      </div>

      <div>
        <h1 class="heading text-center">UniFi Protect Viewer</h1>
        <p class="text-center">Configuration</p>
      </div>

      <form id="configForm">
        <div class="group">
          <label for="url">UniFi Site URL</label>
          <input id="url" name="url" placeholder="https://192.168.1.1/protect/" />
        </div>

        <div class="group">
          <label for="username">Username</label>
          <input id="username" name="username" />
        </div>

        <div class="group">
          <label for="password">Password</label>
          <input id="password" type="password" name="password" />
        </div>

        <div id="error" class="group error" style="display: none"></div>

        <div class="group">
          <button type="submit" id="connectBtn">Save and Connect</button>
        </div>
      </form>

      <div style="margin-top: 20px">
        <p id="statusMessage" class="text-center"></p>
      </div>
    </main>

    <script>
      // Status message
      const statusEl = document.getElementById('statusMessage')

      // Load stored config on page load
      window.addEventListener('DOMContentLoaded', async () => {
        try {
          statusEl.textContent = 'Loading configuration...'

          // Get config using the exposed API
          const config = await window.electronAPI.loadConfig()

          if (config && config.url) {
            document.getElementById('url').value = config.url
            document.getElementById('username').value = config.username || ''
            document.getElementById('password').value = config.password || ''
            statusEl.textContent = 'Configuration loaded'
          } else {
            statusEl.textContent = ''
          }
        } catch (error) {
          console.error('Error loading config:', error)
          statusEl.textContent = 'Error loading configuration'
        }
      })

      // Form validation
      function validateForm() {
        const url = document.getElementById('url').value.trim()
        const username = document.getElementById('username').value.trim()
        const password = document.getElementById('password').value.trim()
        const errors = []

        if (!url) {
          errors.push('URL is required')
        } else {
          try {
            new URL(url)
            // Make sure URL ends with slash
            if (!url.endsWith('/')) {
              document.getElementById('url').value = url + '/'
            }
          } catch (e) {
            errors.push('Invalid URL (must start with https://)')
          }
        }

        if (!username) errors.push('Username is required')
        if (!password) errors.push('Password is required')

        const errorDiv = document.getElementById('error')
        errorDiv.innerHTML = ''

        if (errors.length > 0) {
          errorDiv.style.display = 'block'
          errorDiv.innerHTML = errors.map((err) => `<div>${err}</div>`).join('')
          return false
        }

        errorDiv.style.display = 'none'
        return true
      }

      // Get form values as config object
      function getConfigFromForm() {
        return {
          url: document.getElementById('url').value.trim(),
          username: document.getElementById('username').value.trim(),
          password: document.getElementById('password').value.trim(),
        }
      }

      // Save configuration
      async function saveConfig() {
        if (!validateForm()) return false

        try {
          const config = getConfigFromForm()
          await window.electronAPI.saveConfig(config)
          statusEl.textContent = 'Configuration saved successfully'
          return true
        } catch (error) {
          console.error('Error saving config:', error)
          statusEl.textContent = 'Error saving configuration'
          return false
        }
      }

      // Connect to UniFi Protect site
      async function connectToSite() {
        if (await saveConfig()) {
          statusEl.textContent = 'Connecting to UniFi Protect...'

          try {
            const config = getConfigFromForm()
            // Use direct URL loading instead of restart
            window.electronAPI.loadURL(config.url)
          } catch (error) {
            console.error('Error connecting to site:', error)
            statusEl.textContent = 'Error connecting to site'
          }
        }
      }

      // Reset application
      async function resetApp() {
        try {
          const confirmed = await window.electronAPI.confirmReset()
          if (confirmed) {
            statusEl.textContent = 'Resetting application...'
            window.electronAPI.resetApp()
            window.electronAPI.restartApp()
          }
        } catch (error) {
          console.error('Error during reset:', error)
          statusEl.textContent = 'Error resetting application'
        }
      }

      // Set up button event listeners
      document.getElementById('connectBtn').addEventListener('click', connectToSite)

      // Add form submission handler for Enter key
      document.getElementById('configForm').addEventListener('submit', function (event) {
        event.preventDefault()
        connectToSite()
      })
    </script>
  </body>
</html>
